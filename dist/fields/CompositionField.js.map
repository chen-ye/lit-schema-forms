{"version":3,"file":"CompositionField.js","sourceRoot":"","sources":["../../src/fields/CompositionField.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,EAA4C,MAAM,KAAK,CAAC;AACtF,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AACnE,OAAO,EAAE,WAAW,EAAE,MAAM,YAAY,CAAC;AACzC,OAAO,yDAAyD,CAAC;AAEjE,OAAO,yDAAyD,CAAC;AAIjE,MAAM,CAAC,MAAM,sBAAsB,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;;;;CAkBxC,CAAC;IAGW,mBAAmB;4BAD/B,aAAa,CAAC,uBAAuB,CAAC;;;;sBACE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;mCAAlB,SAAQ,WAAU;;;;kCAChD,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;iCAC1B,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;gCAC1B,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;gCAC1B,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;kCAC1B,QAAQ,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC;mCACzB,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;oCAC1B,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;yCAE9B,KAAK,EAAE;YARoB,uKAAS,MAAM,6BAAN,MAAM,uFAAkB;YACjC,oKAAS,KAAK,6BAAL,KAAK,qFAAsB;YACpC,iKAAS,IAAI,6BAAJ,IAAI,mFAAgB;YAC7B,iKAAS,IAAI,6BAAJ,IAAI,mFAAc;YAC5B,uKAAS,MAAM,6BAAN,MAAM,uFAAyB;YACvC,0KAAS,OAAO,6BAAP,OAAO,yFAAsB;YAClC,6KAAS,QAAQ,6BAAR,QAAQ,2FAA2B;YAEnE,4LAAiB,aAAa,6BAAb,aAAa,qGAAa;YATtD,6KAyHC;;;YAzHY,uDAAmB;;QACF,yEAA8B,EAAE,EAAC;QAAjC,IAAS,MAAM,4CAAkB;QAAjC,IAAS,MAAM,kDAAkB;QACjC,4HAA0B,SAAS,GAAC;QAApC,IAAS,KAAK,2CAAsB;QAApC,IAAS,KAAK,iDAAsB;QACpC,yHAA0B,EAAE,GAAC;QAA7B,IAAS,IAAI,0CAAgB;QAA7B,IAAS,IAAI,gDAAgB;QAC7B,wHAAwB,EAAE,GAAC;QAA3B,IAAS,IAAI,0CAAc;QAA3B,IAAS,IAAI,gDAAc;QAC5B,4HAAqC,EAAE,GAAC;QAAxC,IAAS,MAAM,4CAAyB;QAAxC,IAAS,MAAM,kDAAyB;QACvC,gIAAmC,EAAE,GAAC;QAAtC,IAAS,OAAO,6CAAsB;QAAtC,IAAS,OAAO,mDAAsB;QAClC,mIAAmC,GAAG,EAAE,GAAE,CAAC,GAAC;QAA5C,IAAS,QAAQ,8CAA2B;QAA5C,IAAS,QAAQ,oDAA2B;QAEnE,8IAAyC,CAAC,GAAC;QAA3C,IAAiB,aAAa,mDAAa;QAA3C,IAAiB,aAAa,yDAAa;QAE1C,gBAAgB;YACxB,OAAO,IAAI,CAAC,CAAC,qDAAqD;QACpE,CAAC;QAES,UAAU,CAAC,iBAAiC;YACpD,IAAI,iBAAiB,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,iBAAiB,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;gBACtE,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC/B,CAAC;QACH,CAAC;QAEO,qBAAqB;YAC3B,MAAM,OAAO,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAiB,CAAC;YACzE,IAAI,CAAC,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC;gBAAE,OAAO;YAEhD,IAAI,IAAI,CAAC,KAAK,KAAK,SAAS;gBAAE,OAAO;YAErC,qDAAqD;YACrD,MAAM,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,IAAI,CAAC,KAAK,CAAC;YAEvG,IAAI,SAAS,GAAG,CAAC,CAAC,CAAC;YACnB,IAAI,aAAa,GAAG,CAAC,CAAC,CAAC;YAEvB,OAAO,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,KAAK,EAAE,EAAE;gBAC7B,0CAA0C;gBAC1C,wFAAwF;gBACxF,IAAI,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;oBACrC,IAAI,GAAG,CAAC,IAAI,KAAK,SAAS,IAAI,OAAO,KAAK,QAAQ,EAAE,CAAC;wBAClD,QAAQ;oBACX,CAAC;yBAAM,CAAC;wBACL,OAAO,CAAC,WAAW;oBACtB,CAAC;gBACH,CAAC;gBAED,sDAAsD;gBACtD,IAAI,OAAO,KAAK,QAAQ,IAAI,IAAI,CAAC,KAAK,IAAI,OAAO,IAAI,CAAC,KAAK,KAAK,QAAQ,IAAI,GAAG,CAAC,UAAU,EAAE,CAAC;oBAC3F,MAAM,SAAS,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,KAAe,CAAC,CAAC;oBACpD,MAAM,UAAU,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;oBAC/C,MAAM,YAAY,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;oBAEnE,IAAI,YAAY,CAAC,MAAM,GAAG,aAAa,EAAE,CAAC;wBACxC,aAAa,GAAG,YAAY,CAAC,MAAM,CAAC;wBACpC,SAAS,GAAG,KAAK,CAAC;oBACpB,CAAC;gBACH,CAAC;qBAAM,IAAI,OAAO,KAAK,QAAQ,EAAE,CAAC;oBAChC,kBAAkB;oBAClB,IAAI,SAAS,KAAK,CAAC,CAAC;wBAAE,SAAS,GAAG,KAAK,CAAC;gBAC1C,CAAC;YACH,CAAC,CAAC,CAAC;YAEH,qDAAqD;YACrD,IAAI,SAAS,GAAG,CAAC,CAAC,EAAE,CAAC;gBACnB,IAAI,OAAO,KAAK,QAAQ,EAAE,CAAC;oBACxB,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;gBAClC,CAAC;qBAAM,IAAI,aAAa,GAAG,CAAC,EAAE,CAAC;oBAC5B,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;gBAClC,CAAC;YACH,CAAC;QACH,CAAC;QAEO,kBAAkB,CAAC,CAAQ;YACjC,MAAM,QAAQ,GAAG,MAAM,CAAE,CAAC,CAAC,MAAmB,CAAC,KAAK,CAAC,CAAC;YACtD,IAAI,CAAC,aAAa,GAAG,QAAQ,CAAC;YAE9B,MAAM,OAAO,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAiB,CAAC;YACzE,MAAM,SAAS,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;YAEpC,mDAAmD;YACnD,IAAI,OAAgB,CAAC;YACrB,MAAM,IAAI,GAAG,SAAS,CAAC,IAAI,IAAI,QAAQ,CAAC,CAAC,+BAA+B;YAExE,IAAI,IAAI,KAAK,QAAQ,IAAI,SAAS,CAAC,UAAU;gBAAE,OAAO,GAAG,EAAE,CAAC;iBACvD,IAAI,IAAI,KAAK,OAAO;gBAAE,OAAO,GAAG,EAAE,CAAC;iBACnC,IAAI,IAAI,KAAK,QAAQ;gBAAE,OAAO,GAAG,EAAE,CAAC;iBACpC,IAAI,IAAI,KAAK,QAAQ,IAAI,IAAI,KAAK,SAAS;gBAAE,OAAO,GAAG,CAAC,CAAC;iBACzD,IAAI,IAAI,KAAK,SAAS;gBAAE,OAAO,GAAG,KAAK,CAAC;iBACxC,IAAI,IAAI,KAAK,MAAM;gBAAE,OAAO,GAAG,IAAI,CAAC;YAEzC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACzB,CAAC;QAED,MAAM;YACJ,MAAM,OAAO,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAiB,CAAC;YACzE,IAAI,CAAC,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC;gBACxC,OAAO,IAAI,CAAA,2EAA2E,CAAC;YACzF,CAAC;YAED,MAAM,aAAa,GAAG,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,OAAO,CAAC,CAAC,CAAC,CAAC;YAEhE,OAAO,IAAI,CAAA;;;6CAG8B,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,SAAS;;sBAErD,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC;uBACzB,CAAC,CAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC;;;;cAIjD,OAAO,CAAC,GAAG,CACX,CAAC,GAAe,EAAE,CAAS,EAAE,EAAE,CAAC,IAAI,CAAA;iCACjB,MAAM,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC,KAAK,IAAI,UAAU,CAAC,GAAG,CAAC,EAAE;aAC/D,CACA;;;;UAIH,WAAW,CAAC,SAAS,GAAG,IAAI,CAAC,aAAa,EAAE,aAAa,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE,GAAG,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC;;KAE7J,CAAC;QACJ,CAAC;;;;;;;;SAxHU,mBAAmB;AA2HhC,MAAM,UAAU,sBAAsB,CACpC,GAAW,EACX,MAAkB,EAClB,KAAc,EACd,QAAuB,EACvB,OAAiB,EAAE,EACnB,OAAe,EAAE,EACjB,SAA4B,EAAE,EAC9B,UAA0B,EAAE;IAE5B,OAAO,IAAI,CAAA;;gBAEG,MAAM;eACP,KAAK;kBACF,QAAQ;cACZ,IAAI;cACJ,IAAI;gBACF,MAAM;iBACL,OAAO;;GAErB,CAAC;AACJ,CAAC","sourcesContent":["import { css, html, LitElement, type PropertyValues, type TemplateResult } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { renderField } from './index.js';\nimport '@awesome.me/webawesome/dist/components/select/select.js';\nimport type WaSelect from '@awesome.me/webawesome/dist/components/select/select.js';\nimport '@awesome.me/webawesome/dist/components/option/option.js';\nimport type { ChangeHandler, JSONSchema, UISchema, WidgetRegistry } from '../types.js';\nimport type { ValidationError } from '../utils/validator.js';\n\nexport const compositionFieldStyles = css`\n  .composition-field {\n    border: 1px dashed var(--wa-color-neutral-border-normal);\n    padding: 1rem;\n    border-radius: 4px;\n    margin-bottom: 1rem;\n  }\n  .composition-header {\n    margin-bottom: 1rem;\n  }\n  .composition-label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: bold;\n  }\n  .composition-select {\n    max-width: 300px;\n  }\n`;\n\n@customElement('lsf-composition-field')\nexport class LsfCompositionField extends LitElement {\n  @property({ type: Object }) accessor schema: JSONSchema = {};\n  @property({ type: Object }) accessor value: unknown = undefined;\n  @property({ type: Object }) accessor view: UISchema = {};\n  @property({ type: String }) accessor path: string = '';\n  @property({ type: Array }) accessor errors: ValidationError[] = [];\n  @property({ type: Object }) accessor widgets: WidgetRegistry = {};\n  @property({ attribute: false }) accessor onChange: ChangeHandler = () => {};\n\n  @state() private accessor selectedIndex: number = 0;\n\n  protected createRenderRoot() {\n    return this; // Render in light DOM to inherit styles/form context\n  }\n\n  protected willUpdate(changedProperties: PropertyValues) {\n    if (changedProperties.has('value') || changedProperties.has('schema')) {\n      this.syncSelectionFromData();\n    }\n  }\n\n  private syncSelectionFromData() {\n    const options = (this.schema.oneOf || this.schema.anyOf) as JSONSchema[];\n    if (!options || !Array.isArray(options)) return;\n\n    if (this.value === undefined) return;\n\n    // Try to find a matching schema for the current data\n    const valType = Array.isArray(this.value) ? 'array' : this.value === null ? 'null' : typeof this.value;\n\n    let bestMatch = -1;\n    let maxPropsMatch = -1;\n\n    options.forEach((opt, index) => {\n      // 1. Check strict type match (if defined)\n      // If type is not defined, we assume it *could* match, but exact matches take precedence\n      if (opt.type && opt.type !== valType) {\n        if (opt.type === 'integer' && valType === 'number') {\n           // allow\n        } else {\n           return; // mismatch\n        }\n      }\n\n      // 2. Check property overlap (discriminator heuristic)\n      if (valType === 'object' && this.value && typeof this.value === 'object' && opt.properties) {\n        const valueKeys = Object.keys(this.value as object);\n        const schemaKeys = Object.keys(opt.properties);\n        const intersection = valueKeys.filter(k => schemaKeys.includes(k));\n\n        if (intersection.length > maxPropsMatch) {\n          maxPropsMatch = intersection.length;\n          bestMatch = index;\n        }\n      } else if (valType !== 'object') {\n        // Primitive match\n        if (bestMatch === -1) bestMatch = index;\n      }\n    });\n\n    // Only override user selection if we found a matches\n    if (bestMatch > -1) {\n      if (valType !== 'object') {\n         this.selectedIndex = bestMatch;\n      } else if (maxPropsMatch > 0) {\n         this.selectedIndex = bestMatch;\n      }\n    }\n  }\n\n  private handleOptionChange(e: Event) {\n    const newIndex = Number((e.target as WaSelect).value);\n    this.selectedIndex = newIndex;\n\n    const options = (this.schema.oneOf || this.schema.anyOf) as JSONSchema[];\n    const newSchema = options[newIndex];\n\n    // Create new empty data appropriate for the schema\n    let newData: unknown;\n    const type = newSchema.type || 'object'; // Default to object if missing\n\n    if (type === 'object' || newSchema.properties) newData = {};\n    else if (type === 'array') newData = [];\n    else if (type === 'string') newData = '';\n    else if (type === 'number' || type === 'integer') newData = 0;\n    else if (type === 'boolean') newData = false;\n    else if (type === 'null') newData = null;\n\n    this.onChange(newData);\n  }\n\n  render() {\n    const options = (this.schema.oneOf || this.schema.anyOf) as JSONSchema[];\n    if (!options || !Array.isArray(options)) {\n      return html`<div style=\"color: red\">Invalid schema: missing oneOf/anyOf options</div>`;\n    }\n\n    const currentSchema = options[this.selectedIndex] || options[0];\n\n    return html`\n      <div class=\"composition-field\">\n        <div class=\"composition-header\">\n          <label class=\"composition-label\">${this.schema.title || 'Options'}</label>\n          <wa-select\n              value=${String(this.selectedIndex)}\n              @input=${(e: Event) => this.handleOptionChange(e)}\n              size=\"small\"\n              class=\"composition-select\"\n          >\n            ${options.map(\n              (opt: JSONSchema, i: number) => html`\n              <wa-option value=${String(i)}>${opt.title || `Option ${i + 1}`}</wa-option>\n            `,\n            )}\n          </wa-select>\n        </div>\n\n        ${renderField('option-' + this.selectedIndex, currentSchema, this.value, (_k, val) => this.onChange(val), this.view, this.path, this.errors, this.widgets)}\n      </div>\n    `;\n  }\n}\n\nexport function renderCompositionField(\n  key: string,\n  schema: JSONSchema,\n  value: unknown,\n  onChange: ChangeHandler,\n  view: UISchema = {},\n  path: string = '',\n  errors: ValidationError[] = [],\n  widgets: WidgetRegistry = {},\n) {\n  return html`\n    <lsf-composition-field\n      .schema=${schema}\n      .value=${value}\n      .onChange=${onChange}\n      .view=${view}\n      .path=${path}\n      .errors=${errors}\n      .widgets=${widgets}\n    ></lsf-composition-field>\n  `;\n}\n"]}